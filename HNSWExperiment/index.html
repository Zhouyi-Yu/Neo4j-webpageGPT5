<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UAlberta Research Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark light;
    }
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
    }
    .app {
      max-width: 960px;
      width: 100%;
      padding: 1.5rem;
    }
    h1 {
      font-size: 1.75rem;
      margin-bottom: 0.25rem;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1.5rem;
    }
    .card {
      background: #020617;
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.6);
      border: 1px solid #1e293b;
      margin-bottom: 1rem;
    }
    .row {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .col {
      flex: 1 1 0;
      min-width: 260px;
    }
    textarea {
      width: 100%;
      resize: vertical;
      min-height: 110px;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      font-family: inherit;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    textarea:focus {
      outline: 2px solid #38bdf8;
      border-color: #38bdf8;
    }
    button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, opacity 0.2s;
      box-shadow: 0 10px 20px rgba(96, 165, 250, 0.35);
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }
    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(96, 165, 250, 0.4);
    }
    .button-row {
      margin-top: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .status {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .status.loading::before {
      content: "● ";
      color: #38bdf8;
    }
    .status.error {
      color: #f97373;
    }
    h2 {
      font-size: 1.1rem;
      margin: 0 0 0.5rem;
    }
    pre {
      background: #020617;
      border-radius: 0.5rem;
      padding: 0.75rem;
      font-size: 0.8rem;
      overflow-x: auto;
      border: 1px solid #111827;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .answer-text {
      font-size: 0.98rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    details {
      margin-top: 0.5rem;
    }
    details > summary {
      cursor: pointer;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    .tagline {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.5rem;
    }
    .candidate-list {
  margin-top: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.candidate-info {
  font-size: 0.9rem;
  color: #9ca3af;
}

.candidate-item {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  padding: 0.55rem 0.75rem;
  border-radius: 0.5rem;
  border: 1px solid #1e293b;
  background: #020617;
}

.candidate-label {
  font-size: 0.95rem;
  font-weight: 500;
}

.candidate-meta {
  font-size: 0.8rem;
  color: #6b7280;
}

.candidate-btn {
  align-self: flex-start;
  margin-top: 0.25rem;
  padding: 0.3rem 0.8rem;
  font-size: 0.85rem;
}
.candidate-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 0.5rem;
}

    @media (max-width: 640px) {
      .app {
        padding: 1rem;
      }
      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header style="margin-bottom: 1rem;">
      <h1>UAlberta Research Assistant</h1>
      <div class="subtitle">
        Ask about researchers, topics, collaborations, or department trends.
        Backend: Neo4j + semantic search + GPT-5 pipeline.
      </div>
    </header>

    <!-- Query input -->
    <section class="card">
      <h2>Ask a question</h2>
      <textarea id="questionInput"
                placeholder="Examples:
- What are the main research areas of Marek Reformat?
- How many publications does Petr Musilek have on smart grids?
- Does Lukasz Kurgan work on deep learning?
- Which venues does Witold Pedrycz publish in the most?"></textarea>

      <div class="button-row">
        <button id="askBtn">
          <span id="askBtnLabel">Ask</span>
        </button>
        <div class="status" id="statusText"></div>
      </div>
      <div class="tagline">
        For demo/debug: the response also includes intent JSON, Cypher, raw DB rows, and semantic hits.
      </div>
    </section>

    <!-- Answer + Debug -->
    <section class="row">
      <div class="col">
        <div class="card">
          <h2>Answer</h2>
          <div id="answerText" class="answer-text" style="min-height: 2.5rem; color:#9ca3af;">
            Ask a question to see results here.
          </div>
          <!-- NEW: candidate list goes here when we need disambiguation -->
          <div id="candidateList" class="candidate-list"></div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h2>Debug</h2>
          <details open>
            <summary>Intent (classifier output)</summary>
            <pre id="intentJson">–</pre>
          </details>

          <details>
            <summary>Cypher (generated query)</summary>
            <pre id="cypherText">–</pre>
          </details>

          <details>
            <summary>DB rows (graph query results)</summary>
            <pre id="dbRowsText">–</pre>
          </details>

          <details>
            <summary>Semantic hits (vector search)</summary>
            <pre id="semanticHitsText">–</pre>
          </details>
        </div>
      </div>
    </section>
  </div>

  <script>
    const questionInput = document.getElementById('questionInput');
    const askBtn = document.getElementById('askBtn');
    const askBtnLabel = document.getElementById('askBtnLabel');
    const statusText = document.getElementById('statusText');

    const answerText = document.getElementById('answerText');
    const intentJson = document.getElementById('intentJson');
    const cypherText = document.getElementById('cypherText');
    const dbRowsText = document.getElementById('dbRowsText');
    const semanticHitsText = document.getElementById('semanticHitsText');
    const candidateList = document.getElementById('candidateList');
    let allCandidates = [];
    let candidatePage = 0;
    const CANDIDATES_PER_PAGE = 20;


    function renderCandidates(candidates, originalQuestion) {
  allCandidates = candidates || [];
  candidatePage = 0;
  candidateList.innerHTML = "";

  if (!allCandidates.length) return;

  const info = document.createElement('div');
  info.className = 'candidate-info';
  info.textContent = 'I found multiple researchers matching that name. Please pick one:';
  candidateList.appendChild(info);

  // container for the current page entries
  const itemsContainer = document.createElement('div');
  candidateList.appendChild(itemsContainer);

  // navigation row
  const nav = document.createElement('div');
  nav.className = 'candidate-nav';

  const prevBtn = document.createElement('button');
  prevBtn.type = 'button';
  prevBtn.className = 'candidate-btn';
  prevBtn.textContent = 'Previous';
  prevBtn.disabled = true;

  const pageLabel = document.createElement('span');
  pageLabel.className = 'candidate-meta';

  const nextBtn = document.createElement('button');
  nextBtn.type = 'button';
  nextBtn.className = 'candidate-btn';
  nextBtn.textContent = 'Next';

  nav.appendChild(prevBtn);
  nav.appendChild(pageLabel);
  nav.appendChild(nextBtn);
  candidateList.appendChild(nav);

  function renderPage() {
    itemsContainer.innerHTML = "";

    const totalPages = Math.ceil(allCandidates.length / CANDIDATES_PER_PAGE) || 1;
    const start = candidatePage * CANDIDATES_PER_PAGE;
    const end = start + CANDIDATES_PER_PAGE;
    const pageCandidates = allCandidates.slice(start, end);

    pageCandidates.forEach((c) => {
      const item = document.createElement('div');
      item.className = 'candidate-item';

      const label = document.createElement('div');
      label.className = 'candidate-label';
      const displayName = c.name || c.normalized_name || c.openalex_url || '(unnamed)';
      label.textContent = displayName;

      const meta = document.createElement('div');
      meta.className = 'candidate-meta';
      if (Array.isArray(c.departments) && c.departments.length) {
        const depts = c.departments.filter(Boolean);
        if (depts.length) meta.textContent = depts.join(', ');
      }

      item.appendChild(label);
      if (meta.textContent) item.appendChild(meta);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'candidate-btn';
      btn.textContent = 'Use this researcher';

      btn.addEventListener('click', () => {
        const baseQuestion = originalQuestion || questionInput.value.trim();
        questionInput.value = `For researcher ${displayName}, ${baseQuestion}`;
        candidateList.innerHTML = "";
        askQuestion();
      });

      item.appendChild(btn);
      itemsContainer.appendChild(item);
    });

    pageLabel.textContent = `Page ${candidatePage + 1} of ${Math.max(totalPages, 1)}`;
    prevBtn.disabled = candidatePage <= 0;
    nextBtn.disabled = candidatePage >= totalPages - 1;
  }

  prevBtn.addEventListener('click', () => {
    if (candidatePage > 0) {
      candidatePage -= 1;
      renderPage();
    }
  });

  nextBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(allCandidates.length / CANDIDATES_PER_PAGE) || 1;
    if (candidatePage < totalPages - 1) {
      candidatePage += 1;
      renderPage();
    }
  });

  // initial render
  renderPage();
}


    async function askQuestion() {
      const question = questionInput.value.trim();
      if (!question) {
        statusText.textContent = "Please type a question.";
        statusText.classList.remove('loading');
        statusText.classList.add('error');
        return;
      }

      // Reset UI
      statusText.textContent = "Thinking...";
      statusText.classList.add('loading');
      statusText.classList.remove('error');

      askBtn.disabled = true;
      askBtnLabel.textContent = "Thinking…";

      answerText.style.color = "#9ca3af";
      answerText.textContent = "Working on it...";

      intentJson.textContent = "–";
      cypherText.textContent = "–";
      dbRowsText.textContent = "–";
      semanticHitsText.textContent = "–";
      candidateList.innerHTML = "";


      try {
        const res = await fetch("/api/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errText}`);
        }

        const data = await res.json();

// Disambiguation case: multiple candidate researchers from backend
if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 1) {
  answerText.style.color = "#e5e7eb";
  answerText.textContent = data.answer || "Multiple researchers found. Please choose one:";

  // Show intent JSON (still useful for debugging)
  if (data.intent) {
    intentJson.textContent = JSON.stringify(data.intent, null, 2);
  } else {
    intentJson.textContent = "–";
  }

  cypherText.textContent = data.cypher || "–";
  dbRowsText.textContent = "[]";
  semanticHitsText.textContent = "[]";

  renderCandidates(data.candidates, question);

  statusText.textContent = "Please select a researcher.";
  statusText.classList.remove('loading');
  return; // stop here; wait for user to choose
}

// Normal case: no disambiguation needed
answerText.style.color = "#e5e7eb";
answerText.textContent = data.answer || "(no answer returned)";

if (data.intent) {
  intentJson.textContent = JSON.stringify(data.intent, null, 2);
} else {
  intentJson.textContent = "–";
}

cypherText.textContent = data.cypher || "–";

if (data.dbRows && data.dbRows.length) {
  dbRowsText.textContent = JSON.stringify(data.dbRows, null, 2);
} else {
  dbRowsText.textContent = "[]";
}

if (data.semanticHits && data.semanticHits.length) {
  semanticHitsText.textContent = JSON.stringify(data.semanticHits, null, 2);
} else {
  semanticHitsText.textContent = "[]";
}

statusText.textContent = "Done.";
statusText.classList.remove('loading');
      } catch (err) {
        console.error(err);
        statusText.textContent = "Error: " + err.message;
        statusText.classList.remove('loading');
        statusText.classList.add('error');
        answerText.style.color = "#f97373";
        answerText.textContent = "An error occurred. Check the console and backend logs.";
      } finally {
        askBtn.disabled = false;
        askBtnLabel.textContent = "Ask";
      }
    }

    askBtn.addEventListener('click', askQuestion);
    questionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        askQuestion();
      }
    });
  </script>
</body>
</html>
